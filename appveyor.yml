version: '{build}'
image:
- macOS
- Ubuntu
- Visual Studio 2019
install:
- pwsh: >-
    if($IsMacOS){

    brew install dub ldc

    } if ($IsLinux){

    sudo snap install --classic --channel=edge ldc2

    sudo snap install --classic --channel=edge dub

    } if ($IsWindows){

    choco install ldc

    mv /tools/ldc* /tools/ldc

    }
build_script:
- pwsh: >-
    if($IsWindows){$env:PATH += ";/tools/ldc/bin"}

    dub build :rflink -b release -c lib --parallel

    dub build :uflink -b release -c lib --parallel

    dub build :smerge -b release -c lib --parallel

    dub build -b release -c lib --parallel

    dub build :flink -b release --parallel

    dub build :rflink -b release --parallel

    dub build :uflink -b release --parallel

    dub build :smerge -b release --parallel

    dub build -b release --parallel

    if($IsWindows){
      
      $cliext=".exe"

      $libext=".lib"

    }else{

      $libext=".a"

    }

    "fpm", "util/flink/flink", "util/rflink/rflink", "util/uflink/uflink", "util/smerge/smerge" | ForEach-Object {Push-AppveyorArtifact $_$cliext; Push-AppveyorArtifact $_$libext}
test_script:
- pwsh: >-
    if($IsWindows){$env:PATH += ";/tools/ldc/bin"}

    dub test --parallel